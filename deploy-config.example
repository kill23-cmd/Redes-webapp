# Exemplo de Configura√ß√£o do Servidor para Deploy

# ============================================
# CONFIGURA√á√ÉO DE PRODU√á√ÉO - Nginx
# ============================================

server {
    listen 80;
    listen [::]:80;
    server_name seu-dominio.com;
    root /var/www/network-monitor;
    index index.html;
    
    # Seguran√ßa b√°sica
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
    
    # Cache para arquivos est√°ticos
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }
    
    # Servir arquivos SPA
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # API Zabbix (proxy)
    location /zabbix-api/ {
        proxy_pass https://seu-zabbix.com/api_jsonrpc.php;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
    
    # Logs
    access_log /var/log/nginx/network-monitor.access.log;
    error_log /var/log/nginx/network-monitor.error.log;
}

# HTTPS (recomendado para produ√ß√£o)
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name seu-dominio.com;
    root /var/www/network-monitor;
    index index.html;
    
    # SSL Configuration
    ssl_certificate /etc/letsencrypt/live/seu-dominio.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/seu-dominio.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # Security Headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self' https: 'unsafe-inline' 'unsafe-eval' data: blob:;" always;
    
    # HSTS
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    
    # Cache para arquivos est√°ticos
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }
    
    # Servir arquivos SPA
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # API Zabbix (proxy)
    location /zabbix-api/ {
        proxy_pass https://seu-zabbix.com/api_jsonrpc.php;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
    
    # Logs
    access_log /var/log/nginx/network-monitor.access.log;
    error_log /var/log/nginx/network-monitor.error.log;
}

# ============================================
# CONFIGURA√á√ÉO DE PRODU√á√ÉO - Apache
# ============================================

<VirtualHost *:80>
    ServerName seu-dominio.com
    DocumentRoot /var/www/network-monitor
    
    # Security Headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set X-Content-Type-Options "nosniff"
    Header always set Referrer-Policy "no-referrer-when-downgrade"
    
    # Allow CORS for Zabbix API
    Header set Access-Control-Allow-Origin "*"
    Header set Access-Control-Allow-Methods "GET, POST, OPTIONS"
    Header set Access-Control-Allow-Headers "Content-Type, Authorization"
    
    # Cache Control
    <FilesMatch "\.(js|css|png|jpg|jpeg|gif|ico|svg)$">
        ExpiresActive On
        ExpiresDefault "access plus 1 year"
    </FilesMatch>
    
    # SPA routing
    FallbackResource /index.html
    
    # Proxy para API Zabbix
    ProxyPreserveHost On
    ProxyPass /zabbix-api/ https://seu-zabbix.com/api_jsonrpc.php
    ProxyPassReverse /zabbix-api/ https://seu-zabbix.com/api_jsonrpc.php
    
    ErrorLog ${APACHE_LOG_DIR}/network-monitor_error.log
    CustomLog ${APACHE_LOG_DIR}/network-monitor_access.log combined
</VirtualHost>

<VirtualHost *:443>
    ServerName seu-dominio.com
    DocumentRoot /var/www/network-monitor
    
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/seu-dominio.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/seu-dominio.com/privkey.pem
    
    # Security Headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set X-Content-Type-Options "nosniff"
    Header always set Referrer-Policy "no-referrer-when-downgrade"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    
    # Allow CORS for Zabbix API
    Header set Access-Control-Allow-Origin "*"
    Header set Access-Control-Allow-Methods "GET, POST, OPTIONS"
    Header set Access-Control-Allow-Headers "Content-Type, Authorization"
    
    # Cache Control
    <FilesMatch "\.(js|css|png|jpg|jpeg|gif|ico|svg)$">
        ExpiresActive On
        ExpiresDefault "access plus 1 year"
    </FilesMatch>
    
    # SPA routing
    FallbackResource /index.html
    
    # Proxy para API Zabbix
    ProxyPreserveHost On
    ProxyPass /zabbix-api/ https://seu-zabbix.com/api_jsonrpc.php
    ProxyPassReverse /zabbix-api/ https://seu-zabbix.com/api_jsonrpc.php
    
    ErrorLog ${APACHE_LOG_DIR}/network-monitor_ssl_error.log
    CustomLog ${APACHE_LOG_DIR}/network-monitor_ssl_access.log combined
</VirtualHost>

# ============================================
# SCRIPT DE DEPLOY AUTOM√ÅTICO
# ============================================

#!/bin/bash
# deploy.sh - Script de deploy automatizado

set -e

# Configura√ß√µes
DOMAIN="seu-dominio.com"
APP_DIR="/var/www/network-monitor"
BACKUP_DIR="/var/backups/network-monitor"
REPO_URL="https://github.com/seu-usuario/network-monitor.git"
BRANCH="main"

echo "üöÄ Iniciando deploy do Network Monitor..."

# Backup da vers√£o atual
echo "üì¶ Criando backup..."
mkdir -p "$BACKUP_DIR"
if [ -d "$APP_DIR" ]; then
    cp -r "$APP_DIR" "$BACKUP_DIR/backup-$(date +%Y%m%d-%H%M%S)"
fi

# Atualizar aplica√ß√£o
echo "üì• Baixando nova vers√£o..."
if [ -d "$APP_DIR/.git" ]; then
    cd "$APP_DIR"
    git fetch origin
    git reset --hard origin/$BRANCH
else
    rm -rf "$APP_DIR"
    git clone -b $BRANCH $REPO_URL $APP_DIR
fi

# Definir permiss√µes
echo "üîí Configurando permiss√µes..."
chown -R www-data:www-data $APP_DIR
chmod -R 755 $APP_DIR
chmod -R 644 $APP_DIR/*.html $APP_DIR/*.js $APP_DIR/*.css

# Recarregar servidor web
echo "üîÑ Recarregando servidor web..."
if command -v nginx &> /dev/null; then
    nginx -t && systemctl reload nginx
elif command -v apache2 &> /dev/null; then
    apache2ctl configtest && systemctl reload apache2
fi

echo "‚úÖ Deploy conclu√≠do com sucesso!"
echo "üåê Acesse: https://$DOMAIN"

# Health check
echo "üè• Verificando health check..."
sleep 5
if curl -f -s "https://$DOMAIN" > /dev/null; then
    echo "‚úÖ Aplica√ß√£o rodando normalmente"
else
    echo "‚ùå Problema detectado na aplica√ß√£o"
    exit 1
fi

# ============================================
# CONFIGURA√á√ÉO PM2 (Node.js Proxy)
# ============================================

# Se precisar de um proxy Node.js para CORS

// server.js
const express = require('express');
const { createProxyMiddleware } = require('http-proxy-middleware');
const cors = require('cors');
const helmet = require('helmet');

const app = express();
const PORT = process.env.PORT || 3000;

// Security
app.use(helmet());
app.use(cors({
    origin: ['https://seu-dominio.com', 'http://localhost:3000'],
    credentials: true
}));

// Proxy para Zabbix API
app.use('/api/zabbix', createProxyMiddleware({
    target: 'https://seu-zabbix.com',
    changeOrigin: true,
    pathRewrite: {
        '^/api/zabbix': '/api_jsonrpc.php',
    },
    onProxyReq: (proxyReq, req, res) => {
        console.log(`[PROXY] ${req.method} ${req.url} -> ${proxyReq.path}`);
    },
    onError: (err, req, res) => {
        console.error('Proxy error:', err);
        res.status(500).json({ error: 'Proxy error' });
    }
}));

// Proxy para arquivos est√°ticos
app.use(express.static('public'));

// SPA routing
app.get('*', (req, res) => {
    res.sendFile(__dirname + '/public/index.html');
});

app.listen(PORT, () => {
    console.log(`Server running on port ${PORT}`);
});

// ============================================
# PM2 Ecosystem File
# ============================================

// ecosystem.config.js
module.exports = {
    apps: [{
        name: 'network-monitor-proxy',
        script: './server.js',
        instances: 2,
        exec_mode: 'cluster',
        env: {
            NODE_ENV: 'production',
            PORT: 3000
        },
        log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
        error_file: './logs/err.log',
        out_file: './logs/out.log',
        log_file: './logs/combined.log'
    }]
};

# ============================================
# DOCKER CONFIGURATION
# ============================================

# Dockerfile
FROM nginx:alpine

# Copiar arquivos da aplica√ß√£o
COPY public/ /usr/share/nginx/html/
COPY nginx.conf /etc/nginx/conf.d/default.conf

# Expor porta
EXPOSE 80

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost/ || exit 1

# docker-compose.yml
version: '3.8'

services:
  network-monitor:
    build: .
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./ssl:/etc/nginx/ssl:ro
    environment:
      - TZ=America/Sao_Paulo
    restart: unless-stopped
    
  watchtower:
    image: containrrr/watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=86400
    restart: unless-stopped

# ============================================
# CONFIGURA√á√ÉO SSL - Let's Encrypt
# ============================================

# SSL Certificate renewal script
#!/bin/bash
# ssl-renew.sh

DOMAIN="seu-dominio.com"
WEBROOT="/var/www/network-monitor"

# Stop web server
systemctl stop nginx

# Renew certificate
certbot certonly \
    --webroot \
    -w $WEBROOT \
    -d $DOMAIN \
    --non-interactive \
    --agree-tos \
    --email admin@seu-dominio.com

# Restart web server
systemctl start nginx

echo "SSL certificate renewed successfully!"

# Add to crontab (renewal every 2 months)
# 0 3 1 */2 * /path/to/ssl-renew.sh

# ============================================
# MONITORAMENTO E LOGS
# ============================================

# Script de monitoramento
#!/bin/bash
# monitor.sh

DOMAIN="seu-dominio.com"
LOG_FILE="/var/log/network-monitor-health.log"

check_health() {
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    # Check HTTP status
    local http_status=$(curl -s -o /dev/null -w "%{http_code}" https://$DOMAIN)
    
    if [ "$http_status" = "200" ]; then
        echo "[$timestamp] ‚úÖ Health check OK (HTTP $http_status)" >> $LOG_FILE
        return 0
    else
        echo "[$timestamp] ‚ùå Health check FAILED (HTTP $http_status)" >> $LOG_FILE
        # Send alert (email, slack, etc.)
        echo "Network Monitor health check failed: HTTP $http_status" | mail -s "Alert: Network Monitor Down" admin@seu-dominio.com
        return 1
    fi
}

# Run health check
check_health

# Add to crontab (check every 5 minutes)
# */5 * * * * /path/to/monitor.sh